# name: test/sql/datasketch_tdigest.test
# description: test datasketch TDigest sketches
# group: [datasketches]

# Before we load the extension, this will fail
statement error
SELECT datasketch_tdigest_is_empty(''::blob);
----
Catalog Error: Scalar Function with name datasketch_tdigest_is_empty does not exist!

# Require statement will ensure this test is run with this extension loaded
require datasketches

query I
SELECT datasketch_tdigest(10, 5);
----
\x01\x01\x14\x0A\x00\x06\x00\x00\x00\x00\x00\x00\x00\x00\x14@

query I
SELECT datasketch_tdigest_is_empty('\x01\x01\x14\x0A\x00\x06\x00\x00\x00\x00\x00\x00\x00\x00\x14@'::sketch_tdigest_float);
----
false

# Do some tests with integers.

statement ok
CREATE TABLE readings(temp double)

statement ok
INSERT INTO readings(temp) select unnest(generate_series(1, 1000))::double;

# Rank of 500 should be close to 0.5 (value is in middle of 1-1000 range)
query I
SELECT datasketch_tdigest_rank(datasketch_tdigest(10, temp), 500.0) between 0.4 and 0.6 from readings
----
true

# Median (0.5 quantile) should be close to 500
query I
SELECT datasketch_tdigest_quantile(datasketch_tdigest(10, temp), 0.5) between 350 and 650 from readings
----
true

# CDF and PMF outputs vary, just verify they execute successfully
statement ok
SELECT datasketch_tdigest_cdf(datasketch_tdigest(10, temp), [100, 200, 500]) from readings

statement ok
SELECT datasketch_tdigest_pmf(datasketch_tdigest(10, temp), [100, 200, 500]) from readings

query I
SELECT datasketch_tdigest_k(datasketch_tdigest(10, temp)) from readings
----
10

statement ok
CREATE TABLE sketches (sketch sketch_tdigest_double)

statement ok
INSERT INTO sketches (sketch) select datasketch_tdigest(12, temp) from readings where mod(temp::int, 3) == 0

statement ok
INSERT INTO sketches (sketch) select datasketch_tdigest(12, temp) from readings where mod(temp::int, 3) == 1

statement ok
INSERT INTO sketches (sketch) select datasketch_tdigest(12, temp) from readings where mod(temp::int, 3) == 2

query I
select datasketch_tdigest_is_empty(datasketch_tdigest(12, sketch)) from sketches
----
False

# Merged sketch median should be close to 500
query I
select datasketch_tdigest_quantile(datasketch_tdigest(12, sketch), 0.5)::int between 300 and 700 from sketches
----
true

