# name: test/sql/datasketch_cpc.test
# description: test datasketch CPC sketches
# group: [datasketches]

# Before we load the extension, this will fail
statement error
SELECT datasketch_cpc_is_empty(''::blob);
----
Catalog Error: Scalar Function with name datasketch_cpc_is_empty does not exist!

# Require statement will ensure this test is run with this extension loaded
require datasketches

query I
SELECT datasketch_cpc(8, 5);
----
\x08\x01\x10\x08\x00\x0E\xCC\x93\x01\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\xF8o@\x00\x00\x00\x00\x00\x00\xF0?\xDD\x03\x00\x00

query I
SELECT datasketch_cpc_is_empty('\x08\x01\x10\x08\x00\x0E\xCC\x93\x01\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\xF8o@\x00\x00\x00\x00\x00\x00\xF0?\xDD\x03\x00\x00');
----
false

# Do some tests with integers.

statement ok
CREATE TABLE items(id integer)

statement ok
INSERT INTO items(id) select unnest(generate_series(1, 100000)) order by random()

# Duplicate items shouldn't affect the count.

statement ok
INSERT INTO items(id) select unnest(generate_series(1, 100000)) order by random()

query I
SELECT datasketch_cpc_is_empty(datasketch_cpc(12, id)) from items
----
False


query I
SELECT datasketch_cpc_describe(datasketch_cpc(4, id)) like '%CPC sketch summary%' from items
----
True

# Test with strings

statement ok
CREATE TABLE employees(name string)

statement ok
INSERT INTO employees(name) VALUES
('John Doe'), ('Jane Smith'), ('Michael Johnson'), ('Emily Davis'), ('Chris Brown'), ('Sarah Wilson'), ('David Martinez'),('Sophia Anderson'), ('Daniel Lee'),('Olivia Taylor');

# 10 distinct names, estimate should be close
query I
SELECT datasketch_cpc_estimate(datasketch_cpc(4, name))::int between 8 and 15 from employees
----
true

statement ok
CREATE TABLE sketches (sketch sketch_cpc)

statement ok
INSERT INTO sketches (sketch) select datasketch_cpc(12, id) from items where mod(id, 3) == 0

statement ok
INSERT INTO sketches (sketch) select datasketch_cpc(12, id) from items where mod(id, 3) == 1

statement ok
INSERT INTO sketches (sketch) select datasketch_cpc(12, id) from items where mod(id, 3) == 2

query I
select datasketch_cpc_is_empty(datasketch_cpc_union(12, sketch)) from sketches
----
False

# Test error handling for invalid/corrupted sketch data
statement error
SELECT datasketch_cpc_estimate('\x00\x01\x02\x03'::blob);
----
Invalid Input Error: Failed to deserialize CPC sketch

statement error
SELECT datasketch_cpc_is_empty('\xDE\xAD\xBE\xEF'::blob);
----
Invalid Input Error: Failed to deserialize CPC sketch

# Test with empty blob
statement error
SELECT datasketch_cpc_estimate(''::blob);
----
Invalid Input Error: Failed to deserialize CPC sketch

