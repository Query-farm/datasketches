# name: test/sql/datasketch_frequent.test
# description: Test DataSketches Frequent Items Sketch
# group: [datasketches]

# Ensure the extension is loaded
require datasketches

# -------------------------------------------------------------------
# 1. Basic Estimates (Exact Mode)
# -------------------------------------------------------------------
# For small datasets that fit entirely in the map, counts should be exact.

statement ok
CREATE TABLE fruits(name VARCHAR);

statement ok
INSERT INTO fruits VALUES 
('apple'), ('apple'), ('apple'), 
('banana'), ('banana'), 
('cherry');

# Build the sketch
statement ok
CREATE TABLE fruit_sketch AS SELECT datasketch_frequent_items(name) as sketch FROM fruits;

# Check specific estimates
query I
SELECT datasketch_frequent_items_estimate(sketch, 'apple') FROM fruit_sketch;
----
3

query I
SELECT datasketch_frequent_items_estimate(sketch, 'banana') FROM fruit_sketch;
----
2

query I
SELECT datasketch_frequent_items_estimate(sketch, 'cherry') FROM fruit_sketch;
----
1

query I
SELECT datasketch_frequent_items_estimate(sketch, 'dragonfruit') FROM fruit_sketch;
----
0

# -------------------------------------------------------------------
# 2. Get Frequent Items (Complex Return Type)
# -------------------------------------------------------------------
# Returns: LIST(STRUCT(item VARCHAR, estimate BIGINT, lower_bound BIGINT, upper_bound BIGINT))

# We unnest the list to verify the contents easily
query ITII
SELECT 
    f.item, 
    f.estimate, 
    f.lower_bound, 
    f.upper_bound 
FROM fruit_sketch, 
     UNNEST(datasketch_frequent_items_get_frequent(sketch, 'NO_FALSE_POSITIVES')) as t(f)
ORDER BY f.estimate DESC;
----
apple	3	3	3
banana	2	2	2
cherry	1	1	1

# -------------------------------------------------------------------
# 3. Custom K Parameter
# -------------------------------------------------------------------
# Verify we can pass the lg_max_k parameter (log2 of map size)

statement ok
DROP TABLE fruit_sketch;

# Create with lg_k = 4 (small map)
statement ok
CREATE TABLE fruit_sketch AS SELECT datasketch_frequent_items(4, name) as sketch FROM fruits;

query I
SELECT datasketch_frequent_items_estimate(sketch, 'apple') FROM fruit_sketch;
----
3

# -------------------------------------------------------------------
# 4. Merging Sketches
# -------------------------------------------------------------------

statement ok
CREATE TABLE logs_part1(ip VARCHAR);

statement ok
CREATE TABLE logs_part2(ip VARCHAR);

statement ok
INSERT INTO logs_part1 VALUES ('192.168.1.1'), ('192.168.1.1'), ('10.0.0.1');

statement ok
INSERT INTO logs_part2 VALUES ('192.168.1.1'), ('10.0.0.5');

# Create a table of partial sketches
statement ok
CREATE TABLE partial_sketches(grp INT, sketch sketch_frequent_items);

statement ok
INSERT INTO partial_sketches VALUES 
(1, (SELECT datasketch_frequent_items(ip) FROM logs_part1)),
(2, (SELECT datasketch_frequent_items(ip) FROM logs_part2));

# Merge them using the aggregate function
# Total '192.168.1.1' count should be 2 + 1 = 3
query I
SELECT datasketch_frequent_items_estimate(
    datasketch_frequent_items(sketch), 
    '192.168.1.1'
) 
FROM partial_sketches;
----
3

# -------------------------------------------------------------------
# 5. Heavy Hitters (Approximate Mode)
# -------------------------------------------------------------------
# We generate a dataset where 'heavy_hitter' appears 100 times, 
# and 2000 random distinct items appear once.
# With a small K, the sketch should drop the singletons but keep the heavy hitter.

statement ok
CREATE TABLE stream(item VARCHAR);

# Insert heavy hitter 100 times
statement ok
INSERT INTO stream SELECT 'heavy_hitter' FROM range(0, 100);

# Insert 2000 noise items
statement ok
INSERT INTO stream SELECT 'noise_' || i::VARCHAR FROM range(0, 2000) t(i);

# Use lg_k = 6 (Map size ~64). 
# This is too small to hold 2100 items, so it will purge the noise.
statement ok
CREATE TABLE stream_sketch AS SELECT datasketch_frequent_items(6, item) as sketch FROM stream;

# 1. Check Heavy Hitter is found
query I
SELECT datasketch_frequent_items_estimate(sketch, 'heavy_hitter') >= 100 FROM stream_sketch;
----
true

# 2. Check Noise is likely dropped (estimate 0 or very close to 0)
# Note: exact behavior depends on the purge algorithm, but for lg_k=6, noise should be evicted.
query I
SELECT datasketch_frequent_items_estimate(sketch, 'noise_1') < 5 FROM stream_sketch;
----
true

# 3. Get Frequent List - Should definitely contain heavy_hitter
query T
SELECT f.item 
FROM stream_sketch, 
     UNNEST(datasketch_frequent_items_get_frequent(sketch, 'NO_FALSE_POSITIVES')) as t(f) 
WHERE f.item = 'heavy_hitter';
----
heavy_hitter

# -------------------------------------------------------------------
# 6. Error Type Enum Check
# -------------------------------------------------------------------

# NO_FALSE_NEGATIVES usually returns more items (potentially including noise)
# NO_FALSE_POSITIVES usually returns fewer items (stricter)

query I
SELECT (
    (SELECT count(*) FROM stream_sketch, UNNEST(datasketch_frequent_items_get_frequent(sketch, 'NO_FALSE_NEGATIVES')) t(f))
    >=
    (SELECT count(*) FROM stream_sketch, UNNEST(datasketch_frequent_items_get_frequent(sketch, 'NO_FALSE_POSITIVES')) t(f))
);
----
true

# -------------------------------------------------------------------
# 7. Edge Cases - Empty Tables and NULL Values
# -------------------------------------------------------------------

statement ok
CREATE TABLE empty_table(item VARCHAR);

statement ok
CREATE TABLE empty_sketch AS SELECT datasketch_frequent_items(item) as sketch FROM empty_table;

# Empty sketch should return 0 for any item
query I
SELECT datasketch_frequent_items_estimate(sketch, 'anything') FROM empty_sketch;
----
0

# Test NULL handling - NULLs should be skipped
statement ok
CREATE TABLE with_nulls(item VARCHAR);

statement ok
INSERT INTO with_nulls VALUES ('apple'), (NULL), ('apple'), (NULL), ('banana');

statement ok
CREATE TABLE nulls_sketch AS SELECT datasketch_frequent_items(item) as sketch FROM with_nulls;

# Should only count non-NULL values
query I
SELECT datasketch_frequent_items_estimate(sketch, 'apple') FROM nulls_sketch;
----
2

query I
SELECT datasketch_frequent_items_estimate(sketch, 'banana') FROM nulls_sketch;
----
1

# -------------------------------------------------------------------
# 8. Metadata Functions
# -------------------------------------------------------------------

# Test epsilon (error bound) - should be related to map size
query I
SELECT datasketch_frequent_items_epsilon(sketch) > 0 FROM fruit_sketch;
----
true

# Test total weight - should match total items
query I
SELECT datasketch_frequent_items_total_weight(sketch) FROM fruit_sketch;
----
6

# Test is_empty on non-empty sketch
query I
SELECT datasketch_frequent_items_is_empty(sketch) FROM fruit_sketch;
----
false

# Test is_empty on empty sketch
query I
SELECT datasketch_frequent_items_is_empty(sketch) FROM empty_sketch;
----
true

# Test num_active_items
query I
SELECT datasketch_frequent_items_num_active(sketch) FROM fruit_sketch;
----
3

# -------------------------------------------------------------------
# 9. Upper and Lower Bounds
# -------------------------------------------------------------------

# In exact mode, bounds should equal the estimate
query III
SELECT 
    datasketch_frequent_items_estimate(sketch, 'apple'),
    datasketch_frequent_items_lower_bound(sketch, 'apple'),
    datasketch_frequent_items_upper_bound(sketch, 'apple')
FROM fruit_sketch;
----
3	3	3

# In approximate mode with heavy_hitter
query I
SELECT 
    datasketch_frequent_items_upper_bound(sketch, 'heavy_hitter') >= 
    datasketch_frequent_items_lower_bound(sketch, 'heavy_hitter')
FROM stream_sketch;
----
true

# Bounds should satisfy: lower <= estimate <= upper
query I
SELECT 
    datasketch_frequent_items_lower_bound(sketch, 'heavy_hitter') <= 
    datasketch_frequent_items_estimate(sketch, 'heavy_hitter') AND
    datasketch_frequent_items_estimate(sketch, 'heavy_hitter') <= 
    datasketch_frequent_items_upper_bound(sketch, 'heavy_hitter')
FROM stream_sketch;
----
true

# -------------------------------------------------------------------
# 11. All Items Same Frequency
# -------------------------------------------------------------------

statement ok
CREATE TABLE uniform(item VARCHAR);

statement ok
INSERT INTO uniform VALUES ('a'), ('b'), ('c'), ('d'), ('e');

statement ok
CREATE TABLE uniform_sketch AS SELECT datasketch_frequent_items(item) as sketch FROM uniform;

# All should have estimate = 1
query I
SELECT datasketch_frequent_items_estimate(sketch, 'a') = 
       datasketch_frequent_items_estimate(sketch, 'b') AND
       datasketch_frequent_items_estimate(sketch, 'b') = 
       datasketch_frequent_items_estimate(sketch, 'c')
FROM uniform_sketch;
----
true

# -------------------------------------------------------------------
# 12. Single Item Dataset
# -------------------------------------------------------------------

statement ok
CREATE TABLE singleton(item VARCHAR);

statement ok
INSERT INTO singleton VALUES ('only_one');

statement ok
CREATE TABLE singleton_sketch AS SELECT datasketch_frequent_items(item) as sketch FROM singleton;

query I
SELECT datasketch_frequent_items_estimate(sketch, 'only_one') FROM singleton_sketch;
----
1

query I
SELECT datasketch_frequent_items_total_weight(sketch) FROM singleton_sketch;
----
1

query I
SELECT datasketch_frequent_items_num_active(sketch) FROM singleton_sketch;
----
1

# -------------------------------------------------------------------
# 13. GROUP BY with Multiple Sketches
# -------------------------------------------------------------------

statement ok
CREATE TABLE events(category VARCHAR, event_type VARCHAR);

statement ok
INSERT INTO events VALUES
('web', 'click'), ('web', 'click'), ('web', 'view'),
('mobile', 'click'), ('mobile', 'swipe'), ('mobile', 'swipe'), ('mobile', 'swipe');

# Create sketches per category
statement ok
CREATE TABLE category_sketches AS 
SELECT 
    category, 
    datasketch_frequent_items(event_type) as sketch 
FROM events 
GROUP BY category;

# Verify web category
query I
SELECT datasketch_frequent_items_estimate(sketch, 'click')
FROM category_sketches
WHERE category = 'web';
----
2

# Verify mobile category
query I
SELECT datasketch_frequent_items_estimate(sketch, 'swipe')
FROM category_sketches
WHERE category = 'mobile';
----
3

# -------------------------------------------------------------------
# 14. Serialization Persistence
# -------------------------------------------------------------------

# Create a sketch, insert it, retrieve it, and verify it works
statement ok
CREATE TABLE sketch_storage(id INTEGER, sketch_data sketch_frequent_items);

statement ok
INSERT INTO sketch_storage 
SELECT 1, datasketch_frequent_items(name) FROM fruits;

# Query from stored sketch
query I
SELECT datasketch_frequent_items_estimate(sketch_data, 'apple')
FROM sketch_storage
WHERE id = 1;
----
3

# -------------------------------------------------------------------
# 15. Very Large K Parameter
# -------------------------------------------------------------------

statement ok
CREATE TABLE large_k_data(item VARCHAR);

statement ok
INSERT INTO large_k_data VALUES ('a'), ('b'), ('c');

# Use lg_k = 20 (very large map: 2^20 = ~1M entries)
statement ok
CREATE TABLE large_k_sketch AS SELECT datasketch_frequent_items(20, item) as sketch FROM large_k_data;

query I
SELECT datasketch_frequent_items_estimate(sketch, 'a') FROM large_k_sketch;
----
1

# Epsilon should be very small for large K
query I
SELECT datasketch_frequent_items_epsilon(sketch) < 0.001 FROM large_k_sketch;
----
true

# -------------------------------------------------------------------
# 16. Duplicate Item Streams
# -------------------------------------------------------------------

statement ok
CREATE TABLE duplicates(item VARCHAR);

statement ok
INSERT INTO duplicates SELECT 'repeated' FROM range(0, 1000);

statement ok
CREATE TABLE dup_sketch AS SELECT datasketch_frequent_items(item) as sketch FROM duplicates;

query I
SELECT datasketch_frequent_items_estimate(sketch, 'repeated') FROM dup_sketch;
----
1000

query I
SELECT datasketch_frequent_items_total_weight(sketch) FROM dup_sketch;
----
1000

# Only 1 unique item
query I
SELECT datasketch_frequent_items_num_active(sketch) FROM dup_sketch;
----
1

# -------------------------------------------------------------------
# 17. Zipfian Distribution (Realistic Workload)
# -------------------------------------------------------------------
# Create a Zipf-like distribution where a few items are very frequent

statement ok
CREATE TABLE zipf_data(item VARCHAR);

statement ok
INSERT INTO zipf_data 
SELECT 'rank_' || (i % 10)::VARCHAR 
FROM range(0, 1000) t(i)
WHERE i % 2 = 0  -- 'rank_0' appears most
UNION ALL
SELECT 'rank_' || ((i % 100) / 10)::VARCHAR
FROM range(0, 1000) t(i)
WHERE i % 3 = 0;  -- Add more skew

statement ok
CREATE TABLE zipf_sketch AS SELECT datasketch_frequent_items(8, item) as sketch FROM zipf_data;

# Verify top items are captured
query I
SELECT count(*) > 0
FROM zipf_sketch,
     UNNEST(datasketch_frequent_items_get_frequent(sketch, 'NO_FALSE_POSITIVES')) as t(f)
WHERE f.item = 'rank_0';
----
true

# -------------------------------------------------------------------
# 18. Error Type Difference Verification
# -------------------------------------------------------------------

statement ok
CREATE TABLE error_test(item VARCHAR);

statement ok
INSERT INTO error_test 
SELECT 'freq_' || (i % 5)::VARCHAR FROM range(0, 100) t(i)
UNION ALL
SELECT 'rare_' || i::VARCHAR FROM range(0, 50) t(i);

statement ok
CREATE TABLE error_sketch AS SELECT datasketch_frequent_items(6, item) as sketch FROM error_test;

# NO_FALSE_NEGATIVES should include items that might not be heavy hitters
# NO_FALSE_POSITIVES should only include confirmed heavy hitters

# Get counts for each error type
query I
SELECT count(*) > 0
FROM error_sketch,
     UNNEST(datasketch_frequent_items_get_frequent(sketch, 'NO_FALSE_NEGATIVES')) as t(f);
----
true

query I
SELECT count(*) > 0
FROM error_sketch,
     UNNEST(datasketch_frequent_items_get_frequent(sketch, 'NO_FALSE_POSITIVES')) as t(f);
----
true

# -------------------------------------------------------------------
# 19. Non-Existent Item Queries
# -------------------------------------------------------------------

# Querying items that were never added should return 0
query I
SELECT datasketch_frequent_items_estimate(sketch, 'never_existed') FROM fruit_sketch;
----
0

query II
SELECT 
    datasketch_frequent_items_lower_bound(sketch, 'never_existed'),
    datasketch_frequent_items_upper_bound(sketch, 'never_existed')
FROM fruit_sketch;
----
0	0


# -------------------------------------------------------------------
# 10. Integer Type Support
# -------------------------------------------------------------------

statement ok
CREATE TABLE user_ids(id INTEGER);

statement ok
INSERT INTO user_ids VALUES (101), (101), (101), (202), (202), (303);

statement ok
CREATE TABLE int_sketch AS SELECT datasketch_frequent_items(id) as sketch FROM user_ids;

query I
SELECT datasketch_frequent_items_estimate(sketch, 101) FROM int_sketch;
----
3

query I
SELECT datasketch_frequent_items_estimate(sketch, 202) FROM int_sketch;
----
2

query I
SELECT datasketch_frequent_items_estimate(sketch, 303) FROM int_sketch;
----
1

# Get frequent integers
query ITII
SELECT
    f.item,
    f.estimate,
    f.lower_bound,
    f.upper_bound
FROM int_sketch,
     UNNEST(datasketch_frequent_items_get_frequent(sketch, 'NO_FALSE_POSITIVES')) as t(f)
ORDER BY f.estimate DESC;
----
101	3	3	3
202	2	2	2
303	1	1	1

# -------------------------------------------------------------------
# 20. BIGINT Support
# -------------------------------------------------------------------

statement ok
CREATE TABLE big_numbers(val BIGINT);

statement ok
INSERT INTO big_numbers VALUES 
(9223372036854775807), 
(9223372036854775807), 
(-9223372036854775808);

statement ok
CREATE TABLE bigint_sketch AS SELECT datasketch_frequent_items(val) as sketch FROM big_numbers;

query I
SELECT datasketch_frequent_items_estimate(sketch, 9223372036854775807) FROM bigint_sketch;
----
2

query I
SELECT datasketch_frequent_items_estimate(sketch, -9223372036854775808) FROM bigint_sketch;
----
1

# -------------------------------------------------------------------
# 21. TINYINT Support
# -------------------------------------------------------------------

statement ok
CREATE TABLE tiny_vals(val TINYINT);

statement ok
INSERT INTO tiny_vals VALUES (1), (1), (1), (2), (2), (-128), (127);

statement ok
CREATE TABLE tiny_sketch AS SELECT datasketch_frequent_items(val) as sketch FROM tiny_vals;

query I
SELECT datasketch_frequent_items_estimate(sketch, 1::TINYINT) FROM tiny_sketch;
----
3

query I
SELECT datasketch_frequent_items_estimate(sketch, (-128)::TINYINT) FROM tiny_sketch;
----
1

query I
SELECT datasketch_frequent_items_estimate(sketch, 127::TINYINT) FROM tiny_sketch;
----
1

# -------------------------------------------------------------------
# 22. SMALLINT Support
# -------------------------------------------------------------------

statement ok
CREATE TABLE small_vals(val SMALLINT);

statement ok
INSERT INTO small_vals VALUES (1000), (1000), (-32768), (32767);

statement ok
CREATE TABLE small_sketch AS SELECT datasketch_frequent_items(val) as sketch FROM small_vals;

query I
SELECT datasketch_frequent_items_estimate(sketch, 1000::SMALLINT) FROM small_sketch;
----
2

query I
SELECT datasketch_frequent_items_estimate(sketch, (-32768)::SMALLINT) FROM small_sketch;
----
1

# -------------------------------------------------------------------
# 23. Unsigned Integer Types (UTINYINT, USMALLINT, UINTEGER, UBIGINT)
# -------------------------------------------------------------------

statement ok
CREATE TABLE unsigned_vals(
    ut UTINYINT, 
    us USMALLINT, 
    ui UINTEGER, 
    ub UBIGINT
);

statement ok
INSERT INTO unsigned_vals VALUES 
(255, 65535, 4294967295, 18446744073709551615),
(255, 65535, 4294967295, 18446744073709551615),
(0, 0, 0, 0);

# UTINYINT
statement ok
CREATE TABLE ut_sketch AS SELECT datasketch_frequent_items(ut) as sketch FROM unsigned_vals;

query I
SELECT datasketch_frequent_items_estimate(sketch, 255::UTINYINT) FROM ut_sketch;
----
2

query I
SELECT datasketch_frequent_items_estimate(sketch, 0::UTINYINT) FROM ut_sketch;
----
1

# USMALLINT
statement ok
CREATE TABLE us_sketch AS SELECT datasketch_frequent_items(us) as sketch FROM unsigned_vals;

query I
SELECT datasketch_frequent_items_estimate(sketch, 65535::USMALLINT) FROM us_sketch;
----
2

# UINTEGER
statement ok
CREATE TABLE ui_sketch AS SELECT datasketch_frequent_items(ui) as sketch FROM unsigned_vals;

query I
SELECT datasketch_frequent_items_estimate(sketch, 4294967295::UINTEGER) FROM ui_sketch;
----
2

# UBIGINT
statement ok
CREATE TABLE ub_sketch AS SELECT datasketch_frequent_items(ub) as sketch FROM unsigned_vals;

query I
SELECT datasketch_frequent_items_estimate(sketch, 18446744073709551615::UBIGINT) FROM ub_sketch;
----
2

# -------------------------------------------------------------------
# 24. FLOAT Support
# -------------------------------------------------------------------

statement ok
CREATE TABLE float_vals(val FLOAT);

statement ok
INSERT INTO float_vals VALUES (3.14), (3.14), (3.14), (2.71), (-0.5);

statement ok
CREATE TABLE float_sketch AS SELECT datasketch_frequent_items(val) as sketch FROM float_vals;

query I
SELECT datasketch_frequent_items_estimate(sketch, 3.14::FLOAT) FROM float_sketch;
----
3

query I
SELECT datasketch_frequent_items_estimate(sketch, 2.71::FLOAT) FROM float_sketch;
----
1

query I
SELECT datasketch_frequent_items_estimate(sketch, (-0.5)::FLOAT) FROM float_sketch;
----
1

# -------------------------------------------------------------------
# 25. DOUBLE Support
# -------------------------------------------------------------------

statement ok
CREATE TABLE double_vals(val DOUBLE);

statement ok
INSERT INTO double_vals VALUES 
(3.141592653589793), 
(3.141592653589793), 
(2.718281828459045),
(1.7976931348623157e+308);

statement ok
CREATE TABLE double_sketch AS SELECT datasketch_frequent_items(val) as sketch FROM double_vals;

query I
SELECT datasketch_frequent_items_estimate(sketch, 3.141592653589793::DOUBLE) FROM double_sketch;
----
2

query I
SELECT datasketch_frequent_items_estimate(sketch, 1.7976931348623157e+308::DOUBLE) FROM double_sketch;
----
1

# -------------------------------------------------------------------
# 26. Mixed Types in GROUP BY
# -------------------------------------------------------------------

statement ok
CREATE TABLE mixed_events(category VARCHAR, count_val INTEGER, amount DOUBLE);

statement ok
INSERT INTO mixed_events VALUES
('A', 100, 9.99), ('A', 100, 9.99), ('A', 200, 19.99),
('B', 100, 9.99), ('B', 300, 29.99), ('B', 300, 29.99);

# Integer sketch per category
statement ok
CREATE TABLE mixed_int_sketch AS 
SELECT category, datasketch_frequent_items(count_val) as sketch 
FROM mixed_events GROUP BY category;

query I
SELECT datasketch_frequent_items_estimate(sketch, 100) 
FROM mixed_int_sketch WHERE category = 'A';
----
2

query I
SELECT datasketch_frequent_items_estimate(sketch, 300) 
FROM mixed_int_sketch WHERE category = 'B';
----
2

# Double sketch per category  
statement ok
CREATE TABLE mixed_dbl_sketch AS 
SELECT category, datasketch_frequent_items(amount) as sketch 
FROM mixed_events GROUP BY category;

query I
SELECT datasketch_frequent_items_estimate(sketch, 9.99::DOUBLE) 
FROM mixed_dbl_sketch WHERE category = 'A';
----
2

# -------------------------------------------------------------------
# 27. Bounds Work for All Types
# -------------------------------------------------------------------

query III
SELECT 
    datasketch_frequent_items_estimate(sketch, 255::UTINYINT),
    datasketch_frequent_items_lower_bound(sketch, 255::UTINYINT),
    datasketch_frequent_items_upper_bound(sketch, 255::UTINYINT)
FROM ut_sketch;
----
2	2	2

query III
SELECT 
    datasketch_frequent_items_estimate(sketch, 3.14::FLOAT),
    datasketch_frequent_items_lower_bound(sketch, 3.14::FLOAT),
    datasketch_frequent_items_upper_bound(sketch, 3.14::FLOAT)
FROM float_sketch;
----
3	3	3

